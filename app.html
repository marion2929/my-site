<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>まりおんのサイト | AIアプリ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />

  <style>
    /* --- ページ専用の軽量スタイル --- */
    .app-wrap { max-width: 1100px; margin: 24px auto; padding: 0 16px; }
    .panel { background:#fff; border:1px solid #e5e7eb; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,.06); padding:16px; margin-bottom:16px; }
    .info-row { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .badge { display:inline-block; background:#eef6ff; color:#0b57d0; border:1px solid #cfe2ff; padding:4px 8px; border-radius:8px; font-size:.9rem; }
    .btn-secondary { background:#6b7280; color:#fff; border:none; border-radius:8px; padding:10px 14px; font-weight:700; cursor:pointer; }
    .hint { color:#555; font-size:.95rem; }

    /* アップロード（DnD対応） */
    .dropzone {
      border: 2px dashed #4CAF50; border-radius: 12px; background: #f7fff8;
      padding: 20px; text-align: center; transition: background .2s, border-color .2s; cursor: pointer;
      display:block; position:relative;
    }
    .dropzone.dragover { background:#ecfff0; border-color:#2ca04a; }
    .dropzone input[type="file"] { display: none; }

    /* 横スクロールのサムネリスト */
    .strip { display:flex; gap:12px; overflow-x:auto; padding:8px 4px; scroll-snap-type:x mandatory; }
    .card {
      flex: 0 0 220px; border:1px solid #e5e7eb; border-radius:10px; overflow:hidden;
      background:#fff; box-shadow:0 1px 2px rgba(0,0,0,.05); scroll-snap-align:start; display:flex; flex-direction:column;
    }
    .thumb { aspect-ratio:16/9; background:#111; position:relative; }
    .thumb video { position:absolute; inset:0; width:100%; height:100%; object-fit:cover; }
    .card .meta { padding:10px; display:flex; flex-direction:column; gap:8px; }
    .card .meta .name { font-size:.92rem; color:#333; word-break:break-all; }
    .card .meta .btn { background:#4CAF50; color:#fff; text-align:center; padding:8px 10px; border-radius:8px; font-weight:700; cursor:pointer; user-select:none; }
    .card .meta .btn:hover { filter:brightness(1.05); }

    /* 再生プレイヤー */
    .player { display:grid; grid-template-columns:1fr; gap:8px; }
    .player video { width:100%; max-height:60vh; background:#000; border-radius:12px; }

    /* カウントダウンのオーバーレイ（画面全体） */
    #countdownOverlay {
      position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      background:rgba(0,0,0,.55); z-index:2000; color:#fff; font-size:72px; font-weight:900;
    }
    #countNum { text-shadow:0 6px 24px rgba(0,0,0,.5); }
  </style>
</head>
<body>

  <!-- 共通ヘッダー（partials 方式） -->
  <div data-include="partials/header.html"></div>

  <main class="app-wrap">
    <h2 class="pop-font">動画に合わせて録音するツール</h2>

    <!-- ① 動画アップロード -->
    <section class="panel">
      <h3>① 動画をアップロード</h3>
      <label class="dropzone" id="dropzone">
        <div><strong>ここをクリック</strong> または <strong>動画ファイルをドラッグ＆ドロップ</strong></div>
        <div class="hint">複数アップロード可 / ブラウザ内だけで処理されます</div>
        <input id="fileInput" type="file" accept="video/*" multiple hidden>
      </label>
    </section>

    <!-- ② アップ済み動画一覧 -->
    <section class="panel">
      <h3>② アップした動画一覧</h3>
      <div class="strip" id="strip"></div>
      <div class="hint" style="margin-top:6px;">※ サムネは自動再生（ミュート）します。負荷が高い時は停止する場合があります。</div>
    </section>

    <!-- ③ 再生プレイヤー -->
    <section class="panel">
      <h3>③ 動画再生</h3>
      <div class="player">
        <video id="mainPlayer" controls playsinline></video>
        <div class="info-row">
          <span>選択中：</span>
          <span class="badge" id="selectedName">（未選択）</span>
        </div>
      </div>
    </section>

    <!-- ④ 録音 -->
    <section class="panel">
      <h3>④ 録音（動画と同期）</h3>
      <div class="info-row" style="margin-bottom:8px;">
        <button id="micInit">マイク準備</button>
        <button id="recStart" disabled>● 録音開始</button>
        <button id="recStop" class="btn-secondary" disabled>■ 停止</button>
        <button id="recClear" class="btn-secondary" disabled>⟳ 録り直し</button>
        <span class="badge" id="recStatus">未録音</span>
      </div>
      <div class="info-row" style="margin-top:6px;">
        <label><input type="checkbox" id="playVideoSound" checked> 録音中は動画の音を再生する</label>
        <label><input type="checkbox" id="syncToggle" checked> 動画と同期再生する</label>
      </div>
      <div class="info-row">
        <audio id="voice" controls preload="metadata" style="flex:1;"></audio>
      </div>
      <!-- カウントダウンオーバーレイ -->
      <div id="countdownOverlay" aria-hidden="true"><div id="countNum">3</div></div>
      <p class="hint">※ 録音ボタンを押すと以前の録音はリセットされます。同期ONのときは動画の再生/一時停止/シーク/速度変更に音声が追従します。</p>
    </section>

    <!-- ⑤ MIX（動画＋録音音声を書き出し） -->
    <section class="panel">
      <h3>⑤ MIX（動画＋音声を書き出し）</h3>
      <div class="info-row">
        <button id="mixStart">MIXを作成（WebM）</button>
        <span class="badge" id="mixStatus">準備OK</span>
      </div>
      <p class="hint">※ MIX中は動画が頭から自動再生されます（元動画の音声はミュート）。処理後にプレビューとダウンロードができます。</p>
    </section>

    <!-- ⑥ 完成動画（最大3つ） -->
    <section class="panel">
      <h3>⑥ 完成した動画</h3>
      <div class="strip" id="outStrip"></div>
      <p class="hint">※ 「これを使う」で上のプレイヤーに読み込み、「ダウンロード」で保存できます。</p>
    </section>
  </main>

  <footer>
    <p>© 2025 まりおん All rights reserved.</p>
  </footer>

  <!-- 共通ヘッダーの読み込み -->
  <script src="js/include.js" defer></script>

  <!-- ページ専用JS：一つだけ！ -->
  <script>
    /* =========================
       参照
    ========================= */
    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('fileInput');
    const strip = document.getElementById('strip');
    const mainPlayer = document.getElementById('mainPlayer');
    const selectedName = document.getElementById('selectedName');

    const micInitBtn = document.getElementById('micInit');
    const recStartBtn = document.getElementById('recStart');
    const recStopBtn  = document.getElementById('recStop');
    const recClearBtn = document.getElementById('recClear');
    const recStatus   = document.getElementById('recStatus');

    const playVideoSound = document.getElementById('playVideoSound');
    const syncToggle     = document.getElementById('syncToggle');
    const voice          = document.getElementById('voice');

    const mixBtn = document.getElementById('mixStart');
    const mixStatus = document.getElementById('mixStatus');
    const outStrip = document.getElementById('outStrip');

    const countdownOverlay = document.getElementById('countdownOverlay');
    const countNum = document.getElementById('countNum');

    /* =========================
       状態
    ========================= */
    /** @type {{name:string, url:string, file:File|null, isSample?:boolean}[]} */
    const videos = [];
    /** @type {{name:string, url:string, blob:Blob}[]} */
    const outputs = [];

    let micStream = null, mediaRecorder = null, recChunks = [], voiceUrl = null;

    /* =========================
       サンプル動画（videos/ に置く）
    ========================= */
    const SAMPLE_VIDEOS = [
      { name: "111.mp4", url: "videos/111.mp4", isSample: true },
      { name: "131.mp4", url: "videos/131.mp4", isSample: true },
    ];

    function loadSamples() {
      SAMPLE_VIDEOS.forEach(item => {
        videos.push({ name: item.name, url: item.url, file: null, isSample: true });
        appendCard(videos.length - 1);
      });
      if (!mainPlayer.src && videos.length) selectVideo(0);
    }

    /* =========================
       ユーティリティ
    ========================= */
    const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
    async function runCountdown(sec=3){
      countdownOverlay.style.display='flex';
      for (let i=sec;i>=1;i--){ countNum.textContent=String(i); await sleep(1000); }
      countNum.textContent='Go!'; await sleep(300);
      countdownOverlay.style.display='none';
    }

    /* =========================
       アップロード & 一覧表示
    ========================= */
    dropzone.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', () => {
      if (fileInput.files && fileInput.files.length) {
        handleFiles(fileInput.files); fileInput.value = '';
      }
    });
    ['dragenter','dragover'].forEach(t => {
      dropzone.addEventListener(t, e => { e.preventDefault(); e.stopPropagation(); dropzone.classList.add('dragover'); });
    });
    ['dragleave','drop'].forEach(t => {
      dropzone.addEventListener(t, e => { e.preventDefault(); e.stopPropagation(); dropzone.classList.remove('dragover'); });
    });
    dropzone.addEventListener('drop', (e) => {
      const files = Array.from(e.dataTransfer?.files||[]).filter(f=>f.type.startsWith('video/'));
      if (files.length) handleFiles(files);
    });

    function handleFiles(fileList){
      Array.from(fileList).forEach(file=>{
        if(!file.type.startsWith('video/')) return;
        const url = URL.createObjectURL(file);
        videos.push({ name:file.name, url, file });
        appendCard(videos.length - 1);  // index版で統一
      });
      if (!mainPlayer.src && videos.length) selectVideo(0);
    }

    // サムネカード（indexを渡す版）
    function appendCard(idx) {
      const item = videos[idx];
      if (!item) return;

      const card = document.createElement('div');
      card.className = 'card';

      const thumb = document.createElement('div');
      thumb.className = 'thumb';
      const v = document.createElement('video');
      v.src = item.url; v.muted = true; v.loop = true; v.playsInline = true; v.autoplay = true;
      thumb.appendChild(v);

      const meta = document.createElement('div');
      meta.className = 'meta';

      const name = document.createElement('div');
      name.className = 'name';
      name.textContent = item.name;

      const btn = document.createElement('div');
      btn.className = 'btn';
      btn.textContent = 'これを使う';
      btn.addEventListener('click', () => selectVideo(idx));

      meta.append(name, btn);
      card.append(thumb, meta);
      strip.appendChild(card);
    }

    function selectVideo(index){
      const item = videos[index]; if(!item) return;
      const wasPlaying = !mainPlayer.paused;
      mainPlayer.src = item.url; mainPlayer.currentTime = 0;
      selectedName.textContent = item.name;
      if (wasPlaying) mainPlayer.play().catch(()=>{});
      // 同期ONなら、録音音声の位置も合わせておく
      if (syncToggle.checked && voice.src) {
        voice.currentTime = mainPlayer.currentTime; voice.playbackRate = mainPlayer.playbackRate;
        if (!mainPlayer.paused) voice.play().catch(()=>{});
      }
    }

    window.addEventListener('beforeunload', ()=>{
      videos.forEach(v=>{ if(!v.isSample) try{ URL.revokeObjectURL(v.url); }catch{} });
      if(voiceUrl) URL.revokeObjectURL(voiceUrl);
    });

    /* =========================
       録音（マイク）
    ========================= */
    micInitBtn.addEventListener('click', async ()=>{
      try{
        if (micStream) { micInitBtn.textContent='マイク準備済'; micInitBtn.disabled=true; recStartBtn.disabled=false; return; }
        micStream = await navigator.mediaDevices.getUserMedia({ audio:true });
        mediaRecorder = new MediaRecorder(micStream);
        mediaRecorder.ondataavailable = (e)=>{ if(e.data && e.data.size) recChunks.push(e.data); };
        mediaRecorder.onstop = ()=>{
          if (voiceUrl) URL.revokeObjectURL(voiceUrl);
          const blob = new Blob(recChunks, { type:'audio/webm' });
          recChunks = [];
          voiceUrl = URL.createObjectURL(blob);
          voice.src = voiceUrl;
          recStatus.textContent = '録音完了';
          recClearBtn.disabled = false;
        };
        micInitBtn.textContent='マイク準備済'; micInitBtn.disabled=true; recStartBtn.disabled=false;
      }catch(e){ alert('マイクの初期化に失敗しました: ' + e.message); }
    });

    // 同期再生（動画⇄音声）
    (function bindSync(){
      const v=mainPlayer, a=voice;
      v.addEventListener('play',   ()=>{ if(!syncToggle.checked||!a.src) return; a.playbackRate=v.playbackRate; a.currentTime=v.currentTime; a.play().catch(()=>{}); });
      v.addEventListener('pause',  ()=>{ if(!syncToggle.checked||!a.src) return; a.pause(); });
      v.addEventListener('seeking',()=>{ if(!syncToggle.checked||!a.src) return; a.currentTime=v.currentTime; });
      v.addEventListener('ratechange',()=>{ if(!syncToggle.checked||!a.src) return; a.playbackRate=v.playbackRate; });
      v.addEventListener('ended',  ()=>{ if(!syncToggle.checked||!a.src) return; a.pause(); a.currentTime=0; });
      syncToggle.addEventListener('change', ()=>{
        if(!a.src) return;
        if(syncToggle.checked){ a.playbackRate=v.playbackRate; a.currentTime=v.currentTime; if(!v.paused) a.play().catch(()=>{}); }
        else { a.pause(); }
      });
    })();

    // 録音開始（カウントダウン→動画と同時スタート）
    recStartBtn.addEventListener('click', async ()=>{
      if(!mediaRecorder){ alert('先に「マイク準備」を押してください'); return; }
      if(!mainPlayer.src){ alert('先に動画を選んでください'); return; }

      // 上書きクリア
      if (voiceUrl) { URL.revokeObjectURL(voiceUrl); voiceUrl=null; voice.removeAttribute('src'); }
      recChunks = [];

      // カウントダウン
      recStatus.textContent='準備中…'; recStartBtn.disabled=true; recStopBtn.disabled=true;
      await runCountdown(3);

      try{
        // 動画準備
        mainPlayer.pause(); mainPlayer.currentTime=0; mainPlayer.playbackRate=1.0;
        mainPlayer.muted = !(playVideoSound.checked); // チェックONなら動画の音を出す

        // 同時スタート
        await mainPlayer.play().catch(()=>{});
        mediaRecorder.start(100);
        recStatus.textContent='録音中…';
        recStopBtn.disabled=false;

        // 動画終了で自動停止
        const onEnd=()=>{ if(mediaRecorder.state!=='inactive') mediaRecorder.stop(); recStopBtn.disabled=true; recStartBtn.disabled=false; mainPlayer.removeEventListener('ended', onEnd); };
        mainPlayer.addEventListener('ended', onEnd);
      }catch(e){
        alert('録音開始に失敗：'+e.message);
        recStatus.textContent='未録音'; recStartBtn.disabled=false; recStopBtn.disabled=true;
      }
    });

    // 録音停止
    recStopBtn.addEventListener('click', ()=>{
      if(!mediaRecorder || mediaRecorder.state==='inactive') return;
      mediaRecorder.stop();
      recStopBtn.disabled=true; recStartBtn.disabled=false;
    });

    // 録り直し
    recClearBtn.addEventListener('click', ()=>{
      if(voiceUrl){ URL.revokeObjectURL(voiceUrl); voiceUrl=null; }
      voice.removeAttribute('src'); recStatus.textContent='未録音'; recClearBtn.disabled=true;
    });

    /* =========================
       MIX（動画 + 録音音声 → WebM）
    ========================= */
    mixBtn.addEventListener('click', async ()=>{
      if(!mainPlayer.src){ alert('先に動画を選んでください。'); return; }
      if(!voice.src){ alert('先に音声を録音してください。'); return; }

      try{
        mixBtn.disabled=true; mixStatus.textContent='MIX中…（しばらくお待ちください）';

        const wasMuted = mainPlayer.muted;
        mainPlayer.muted = true;

        const vStream = mainPlayer.captureStream();
        const [videoTrack] = vStream.getVideoTracks();
        if(!videoTrack){ throw new Error('captureStream() から映像トラックを取得できません。'); }

        const ac = new (window.AudioContext||window.webkitAudioContext)();
        const dest = ac.createMediaStreamDestination();
        const a = new Audio(); a.src=voice.src; a.playbackRate=mainPlayer.playbackRate; a.preload='auto';
        const srcNode = ac.createMediaElementSource(a);
        srcNode.connect(dest); // 録画用オーディオ出力

        const composed = new MediaStream([videoTrack, ...dest.stream.getAudioTracks()]);
        let recorder; const opt={ mimeType:'video/webm; codecs=vp9,opus' };
        try{ recorder = new MediaRecorder(composed, opt); } catch{ recorder = new MediaRecorder(composed); }
        const chunks=[]; recorder.ondataavailable=(e)=>{ if(e.data&&e.data.size) chunks.push(e.data); };
        const stopRecording=()=>new Promise(res=>{ recorder.onstop=()=>res(new Blob(chunks,{type:'video/webm'})); if(recorder.state!=='inactive') recorder.stop(); });

        mainPlayer.currentTime=0; a.currentTime=0;
        await mainPlayer.play().catch(()=>{}); await a.play().catch(()=>{});
        recorder.start(250);

        await new Promise(resolve=>{ const onEnd=()=>{ mainPlayer.removeEventListener('ended', onEnd); resolve(); }; mainPlayer.addEventListener('ended', onEnd); });
        const outBlob = await stopRecording();

        mainPlayer.pause(); a.pause(); srcNode.disconnect(); mainPlayer.muted = wasMuted;

        const url = URL.createObjectURL(outBlob);
        const name = (selectedName.textContent||'output') + '_' + new Date().toISOString().replace(/[:.]/g,'-') + '.webm';
        outputs.push({ name, url, blob: outBlob });
        while(outputs.length>3){ const old=outputs.shift(); try{ URL.revokeObjectURL(old.url); }catch{} }
        renderOutputs();

        mixStatus.textContent='MIX完了！'; mixBtn.disabled=false;
      }catch(e){
        console.error(e); alert('MIXに失敗しました：'+e.message);
        mixStatus.textContent='エラー'; mixBtn.disabled=false;
      }
    });

    function renderOutputs(){
      outStrip.innerHTML='';
      outputs.forEach(item=>{
        const card=document.createElement('div'); card.className='card';
        const thumb=document.createElement('div'); thumb.className='thumb';
        const v=document.createElement('video'); v.src=item.url; v.muted=true; v.loop=true; v.playsInline=true; v.autoplay=true;
        thumb.appendChild(v);

        const meta=document.createElement('div'); meta.className='meta';
        const name=document.createElement('div'); name.className='name'; name.textContent=item.name;

        const row=document.createElement('div'); row.style.display='flex'; row.style.gap='8px';

        const useBtn=document.createElement('div'); useBtn.className='btn'; useBtn.textContent='これを使う';
        useBtn.addEventListener('click', ()=>{
          // 二重再生防止：同期音声を止めてから
          syncToggle.checked = false;
          try { voice.pause(); } catch(_) {}

          const wasPlaying=!mainPlayer.paused;
          mainPlayer.src=item.url; mainPlayer.currentTime=0; selectedName.textContent=item.name;
          if(wasPlaying) mainPlayer.play().catch(()=>{});
        });

        const dlBtn=document.createElement('a'); dlBtn.className='btn'; dlBtn.textContent='ダウンロード'; dlBtn.href=item.url; dlBtn.download=item.name;

        row.append(useBtn, dlBtn);
        meta.append(name, row);
        card.append(thumb, meta);
        outStrip.appendChild(card);
      });
    }

    /* =========================
       起動時：サンプルを読み込む
    ========================= */
    loadSamples();
  </script>
</body>
</html>
